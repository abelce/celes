(function ($) {
    var LocalWeb3 = require('web3')
    if (typeof web3 !== "undefined") {
        var Web3 = new LocalWeb3(web3.currentProvider)
    }
    var ua = navigator.userAgent;
    var checker = {
        iphone: ua.match(/(iPhone|iPod|iPad)/),
        blackberry: ua.match(/BlackBerry/),
        android: ua.match(/Android/)
    };
    var delay = (function () {
        var timer = 0;
        return function (callback, ms) {
            clearTimeout(timer);
            timer = setTimeout(callback, ms)
        }
    })();
    var urlHash = window.location.hash.substr(1);
    $(window).load(function () {
        console.clear();
        if (urlHash == 'signup') {
            $(".signup-overlay").fadeIn(500);
            $("body").css("overflow", "hidden")
        }
        $(".metamask.install").on("click", function (e) {
            $(this).hide();
            $("#before-install").hide();
            $("#after-install").show();
            $(".metamask.installed").show()
        });
        $(".metamask.installed").on("click", function (e) {
            var url = 'http://' + window.location.hostname + '/';
            var hash = '#signup';
            window.open(url + hash, "_self")
        });
        if (typeof web3 == "undefined") {
            $(".signup-wrapper").hide()
        } else if (Web3.eth.accounts[0] === '' || Web3.eth.accounts[0] === undefined) {
            $(".metamask-locked").show();
            $(".metamask-wrapper").hide();
            $(".signup-popup").hide()
        } else if (Web3.eth.accounts[0]) {
            $("#wallet-addr").val(Web3.eth.accounts[0]);
            $(".control-label.wallet").text("We auto detected your metamask address:");
            $(".metamask-wrapper").hide()
        }
        if (checker.android || checker.iphone || checker.blackberry) {
            $(".metamask-wrapper").hide();
            $(".mobile-wrapper").show();
            $(".signup-wrapper").hide();
            $(".signup-popup h2").text(" ");
            $(".signup-popup h2").css("border", "none")
        }
        $(".buy-contract").on('click', function (e) {
            $(this).css('opacity', '0.5');
            resetPayment();
            $.ajax({
                type: "POST",
                url: CryptoC.ajaxurl,
                data: "item=" + $(this).data("id") + "&action=buy",
                success: function (result) {
                    $('.buy-contract').css('opacity', '1');
                    $(".celeb-name").text(result.name);
                    $(".current-price").text(result.current_price);
                    $(".paid-value").text(result.paid);
                    if (typeof web3 == "undefined") {
                        $('.buy-container').fadeIn(500);
                        $("body").css("overflow", "hidden");
                        return renderMsg('<div>You need to install <a href="https://metamask.io" target="_blank">MetaMask </a> to start trading..</div>')
                    } else if (result.env === "production" && Web3.version.network != 1) {
                        $('.wrong-network').fadeIn(500);
                        $("body").css("overflow", "hidden")
                    } else {
                        $(".buy-container").fadeIn(500);
                        $("#payWithMetaMask #data-id").val(result.id);
                        $("#payWithMetaMask #data-value").val(result.next_price)
                    }
                }
            })
        });
        $(".buy-container #close").on('click', function () {
            $(".buy-container").fadeOut();
            $(".buy-contract").css('opacity', '1');
            $(".celeb-name").text('');
            $(".celeb-value").text('');
            $(".current-price").text('');
            $(".next-price").text('');
            $("body").css("overflow", "")
        });
        $("#payWithMetaMask .payButton").on('click', function () {
            $(this).hide();
            $("#payWithMetaMask .loader").fadeIn();
            if (typeof web3 == "undefined") {
                return renderMsg('<div>You need to install <a href="https://metamask.io" target="_blank">MetaMask </a> to start trading..</div>');
                $("#payWithMetaMask .loader").hide()
            }
            if (typeof web3 == "undefined" && checker.android || checker.iphone || checker.blackberry) {
                return renderMsg('<div>You can only trading on CryptoCelebrities using a desktop browser like Chrome or Firefox. <br><a href="/faq/">See our FAQ for more information</a></div>');
                $("#payWithMetaMask .loader").hide()
            } else {
                $.ajax({
                    type: "POST",
                    url: CryptoC.ajaxurl,
                    data: $("#payWithMetaMask").serialize() + "&action=pay_metamask",
                    success: function (result) {
                        clearMsg();
                        const contract_address = result.contract_address;
                        const amount = Web3.toWei(result.value, 'ether');
                        const tokenId = result.tokenId;
                        const account = Web3.eth.accounts[0];
                        if (account === "" || account === undefined) {
                            $("#payWithMetaMask .loader").hide();
                            $("#payWithMetaMask .payButton").show();
                            renderMsg('Your MetaMask is locked. Please unlock and try again.')
                        } else if (account !== result.user_address) {
                            $("#payWithMetaMask .loader").hide();
                            $("#payWithMetaMask .payButton").show();
                            renderMsg('The active wallet address in your MetaMask account does not match the wallet address in your CryptoCelebrities account.')
                        } else if (account) {
                            const eth = new Eth(Web3.currentProvider);
                            const contract = eth.contract(ABI).at(contract_address);
                            contract.purchase(tokenId, {
                                from: result.user_address,
                                value: amount,
                                gas: gasLimit
                            }).then(function (txHash) {
                                $("#etherscans-url").html('<a href="https://etherscan.io/tx/' + txHash + '" target="_blank">https://etherscan.io/tx/' + txHash + '</a>');
                                $(".before-payment").slideUp(400);
                                $(".after-payment").slideDown(1000)
                            }).catch(function () {
                                $("#payWithMetaMask .loader").hide();
                                $("#payWithMetaMask .payButton").show();
                                renderMsg('You cancelled the transaction or your connection was lost before the transaction finalized.');
                                console.clear()
                            })
                        } else {
                            $("#payWithMetaMask .loader").hide();
                            $("#payWithMetaMask .payButton").show();
                            renderMsg('Please unlock your MetaMask account and try again.')
                        }
                    }
                })
            }
        });

        function renderMsg(msg) {
            $('#payWithMetaMask .message').addClass("alert alert-warning").html(msg)
        }

        function clearMsg() {
            $('#payWithMetaMask .message').removeClass("alert alert-warning").html('')
        }

        function resetPayment() {
            clearMsg();
            $("#payWithMetaMask .payButton").show();
            $(".before-payment").show();
            $(".after-payment").hide();
            $("#payWithMetaMask .loader").hide()
        }

        var clipboard = new Clipboard('#copy-address');
        clipboard.on('success', function (e) {
            toastr.success("Contract address copied to clipboard");
            e.clearSelection()
        });
        clipboard.on('error', function (e) {
            toastr.error("Failed to copy contract address")
        });
        if (Web3.version.network != 1) {
            $("#page-container").prepend('<div class="wrong-network" style="display:none"> <div class="activity-locked"> <h1>Oops, you鈥檙e on the wrong network</h1> <p>Simply open MetaMask and switch over to the <b>Main Ethereum Network.</b></p> <img src="/wp-content/plugins/systems/public/css/images/wrong-network.png"/> </div> <a href=""><span class="cc-icon" id="close">&#x51;</span></a></div>')
        }
    });
    $(document).ready(function ($) {
        $('.biodata-celebrity').readmore({moreLink: '<a href="#">Read more...</a>',});
        $("#viewall-trxs").on('click', function (e) {
            e.preventDefault();
            $(".transactions-popup").fadeIn();
            $("body").css("overflow", "hidden")
        });
        $(".transactions-popup #close").on('click', function (e) {
            e.preventDefault();
            $(".transactions-popup").fadeOut();
            $("body").css("overflow", "")
        });
        var clipboard = new Clipboard('#copy-instruction');
        clipboard.on('success', function (e) {
            toastr.options.positionClass = 'toast-top-right';
            toastr.success("The text copied to clipboard")
        });
        clipboard.on('error', function (e) {
            toastr.options.positionClass = 'toast-top-right';
            toastr.warning("Failed to copy the text")
        });
        $("input[name=send_to]").change(function () {
            var send_to = $('input[name=send_to]:checked').val();
            if (send_to == "charity") {
                $("#wallet-field").slideUp(700);
                $("#charity-field").slideDown(1000);
                $("#wallet").val('')
            } else if (send_to == "wallet") {
                $("#charity-field").slideUp(700);
                $("#wallet-field").slideDown(1000)
            }
        });
        $('#celebrity-signup button').on('click', function (e) {
            e.preventDefault();
            $("#celebrity-signup").css("opacity", "0.7");
            var formData = $("#celebrity-signup").serialize();
            $.ajax({
                type: "POST",
                url: CryptoC.ajaxurl,
                data: formData + "&action=celebrity_signup",
                success: function (result) {
                    $("#celebrity-signup").css("opacity", "1");
                    toastr.options.positionClass = 'toast-bottom-left';
                    if (result.err) {
                        toastr.warning(result.err)
                    } else if (result.ok) {
                        $("#celebrity-signup .success").fadeIn();
                        $("#celebrity-signup").trigger("reset");
                        $("#instruction").val(result.instruction);
                        $("#copy-instruction").show()
                    }
                }
            })
        })
    });
    $(document).ready(function ($) {
        $('.marquee').marquee({duration: 15000, gap: 1, pauseOnHover: !0, duplicated: !0});
        $(".signup-overlay #close").on('click', function () {
            $(".signup-overlay").fadeOut(500);
            $("body").css("overflow", "")
        });
        $(".start-trading").on('click', function () {
            $(".signup-overlay").fadeIn(500);
            $("body").css("overflow", "hidden")
        });
        $(".btn-start").on('click', function () {
            $(".signup-overlay").fadeIn(500);
            $("body").css("overflow", "hidden")
        })
    });
    $(document).ready(function ($) {
        $("#signup .btn-signup").on('click', function (e) {
            e.preventDefault();
            $("#signup").css("opacity", "0.7");
            var formData = $("#signup").serialize();
            $.ajax({
                type: "POST", url: CryptoC.ajaxurl, data: formData + "&action=signup", success: function (result) {
                    $("#signup").css("opacity", "1");
                    if (result.err) {
                        toastr.warning(result.err)
                    } else if (result.ok) {
                        $(".signup-overlay").fadeOut();
                        swal({
                            title: "Congratulations!",
                            text: result.ok,
                            icon: "success",
                            button: "Ready for trading",
                        }).then((value) => {location.replace('/marketplace/')
                    })
                    }
                }
            })
        })
    })
})(jQuery);
(function ($) {
    $(document).ready(function ($) {
        $("#account #start").on('click', function (e) {
            e.preventDefault();
            $("#account input").prop('disabled', !1);
            $(this).hide();
            $("#account #cancel").show();
            $("#account #save").show()
        });
        $("#account #cancel").on('click', function (e) {
            e.preventDefault();
            $("#account input").prop('disabled', !0);
            $("#account #cancel").hide();
            $("#account #save").hide();
            $("#account #start").show()
        });
        $("#account #save").on('click', function (e) {
            $("#account").css("opacity", "0.7");
            e.preventDefault();
            var formData = $("#account").serialize();
            $.ajax({
                type: "POST",
                url: CryptoC.ajaxurl,
                data: formData + "&action=edit_account",
                success: function (result) {
                    $("#account").css("opacity", "1");
                    if (result.err) {
                        toastr.error(result.err)
                    } else if (result.ok) {
                        toastr.success(result.ok);
                        $("#account input").prop('disabled', !0);
                        $("#account #cancel").hide();
                        $("#account #save").hide();
                        $("#account #start").show()
                    } else {
                        toastr.warning("No data updated.")
                    }
                }
            })
        });
        $("#change-password .save").on('click', function (e) {
            $("#change-password").css("opacity", "0.7");
            e.preventDefault();
            var formData = $("#change-password").serialize();
            $.ajax({
                type: "POST",
                url: CryptoC.ajaxurl,
                data: formData + "&action=change_password",
                success: function (result) {
                    $("#change-password").css("opacity", "1");
                    if (result.err) {
                        toastr.error(result.err)
                    } else if (result.ok) {
                        swal("Great!", result.ok, "success").then((value) => {window.location.replace("/sign-in/")
                    })
                    }
                }
            })
        });
        $("#edit-bio-celeb #save").on('click', function (e) {
            $("#edit-bio-celeb").css("opacity", "0.7");
            e.preventDefault();
            var biodata = tinymce.activeEditor.getContent();
            var item_id = $(this).data("id");
            $.ajax({
                type: "POST",
                url: CryptoC.ajaxurl,
                data: "&item=" + item_id + "&biodata=" + biodata + "&action=edit_celebrity_bio",
                success: function (result) {
                    $("#edit-bio-celeb").css("opacity", "1");
                    if (result.err) {
                        toastr.warning(result.err)
                    } else if (result.ok) {
                        swal({
                            title: "Good job!",
                            text: result.ok,
                            icon: "success",
                        }).then((value) => {location.replace('?edit=done')
                    })
                    } else {
                        toastr.warning("System error. Please try again or contact us.")
                    }
                }
            })
        })
    })
})(jQuery)